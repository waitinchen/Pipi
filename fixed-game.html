<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>melonJS 修复版本</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        #screen {
            border: 2px solid #333;
            background-color: #87CEEB;
        }
        .info {
            margin: 10px 0;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>melonJS 修复版本</h1>
    <div class="info">使用 WASD 或方向键移动红色方块</div>
    <div id="screen"></div>
    
    <script type="module">
        import * as me from './node_modules/melonjs/dist/melonjs.module.js';

        // 创建玩家实体类
        class Player extends me.Renderable {
            constructor(x, y) {
                super(x, y, 32, 32);
                
                // 设置物理属性
                this.body = new me.Body(this);
                this.body.addShape(new me.Rect(0, 0, 32, 32));
                this.body.setMaxVelocity(3, 15);
                this.body.setFriction(0.4, 0);
                this.body.collisionType = me.collision.types.PLAYER_OBJECT;
                
                // 确保可见
                this.visible = true;
                this.alpha = 1.0;
            }
            
            update(dt) {
                // 处理输入
                if (me.input.isKeyPressed("left") || me.input.isKeyPressed("a")) {
                    this.body.force.x = -this.body.maxVel.x;
                } else if (me.input.isKeyPressed("right") || me.input.isKeyPressed("d")) {
                    this.body.force.x = this.body.maxVel.x;
                } else {
                    this.body.force.x = 0;
                }
                
                if (me.input.isKeyPressed("up") || me.input.isKeyPressed("w")) {
                    if (this.body.vel.y === 0) {
                        this.body.vel.y = -this.body.maxVel.y;
                    }
                }
                
                // 限制玩家在画布范围内
                if (this.pos.x < 0) this.pos.x = 0;
                if (this.pos.x > 768) this.pos.x = 768; // 800 - 32
                if (this.pos.y < 0) this.pos.y = 0;
                if (this.pos.y > 418) this.pos.y = 418; // 450 - 32
                
                super.update(dt);
                return true;
            }
            
            draw(renderer) {
                // 强制设置颜色和绘制
                renderer.setColor("#FF0000");
                renderer.fillRect(0, 0, this.width, this.height);
                
                // 添加边框以便更容易看到
                renderer.setColor("#000000");
                renderer.strokeRect(0, 0, this.width, this.height);
            }
        }

        // 创建平台实体类
        class Platform extends me.Renderable {
            constructor(x, y, width, height) {
                super(x, y, width, height);
                
                this.body = new me.Body(this);
                this.body.addShape(new me.Rect(0, 0, width, height));
                this.body.collisionType = me.collision.types.WORLD_SHAPE;
                this.body.isStatic = true;
                
                // 确保可见
                this.visible = true;
                this.alpha = 1.0;
            }
            
            draw(renderer) {
                renderer.setColor("#8B4513");
                renderer.fillRect(0, 0, this.width, this.height);
                
                // 添加边框
                renderer.setColor("#000000");
                renderer.strokeRect(0, 0, this.width, this.height);
            }
        }

        // 游戏状态类
        class GameState extends me.Stage {
            constructor() {
                super();
            }
            
            onResetEvent() {
                console.log("Game state initialized");
                
                // 设置重力
                me.game.world.gravity.set(0, 0.98);
                
                // 创建玩家 - 放在画布中央，确保可见
                this.player = new Player(100, 100);
                me.game.world.addChild(this.player);
                
                // 创建平台 - 调整位置确保玩家能看到
                const platforms = [
                    new Platform(0, 400, 800, 50),      // 地面
                    new Platform(200, 300, 100, 20),     // 平台1
                    new Platform(400, 250, 100, 20),     // 平台2
                    new Platform(600, 200, 100, 20),     // 平台3
                ];
                
                platforms.forEach(platform => {
                    me.game.world.addChild(platform);
                });
                
                // 添加输入绑定
                me.input.bindKey(me.input.KEY.LEFT, "left");
                me.input.bindKey(me.input.KEY.RIGHT, "right");
                me.input.bindKey(me.input.KEY.UP, "up");
                me.input.bindKey(me.input.KEY.A, "a");
                me.input.bindKey(me.input.KEY.D, "d");
                me.input.bindKey(me.input.KEY.W, "w");
                
                console.log("Game objects created successfully");
            }
            
            onDestroyEvent() {
                me.input.unbindKey(me.input.KEY.LEFT);
                me.input.unbindKey(me.input.KEY.RIGHT);
                me.input.unbindKey(me.input.KEY.UP);
                me.input.unbindKey(me.input.KEY.A);
                me.input.unbindKey(me.input.KEY.D);
                me.input.unbindKey(me.input.KEY.W);
            }
        }

        // 初始化游戏
        me.device.onReady(function () {
            console.log("Device ready, initializing game...");
            
            // 使用 Canvas 2D 渲染器
            if (!me.video.init(800, 450, {
                parent: "screen", 
                scale: "auto",
                renderer: me.video.CANVAS
            })) {
                alert("您的浏览器不支持 HTML5 canvas。");
                return;
            }

            console.log("Video initialized with Canvas 2D");

            // 设置背景色
            me.game.world.backgroundColor.parseCSS("#87CEEB");
            
            // 设置游戏状态
            me.state.set(me.state.PLAY, new GameState());
            me.state.change(me.state.PLAY);
            
            console.log("Game started successfully");
        });
    </script>
</body>
</html>